---
layout: post
title: "nomå­¦ä¹ "
date:   2025-09-03
tags: [ruståº“]
comments: true
author: VR2050
toc: true
---

#### ä»Šå¤©æ˜¯å¤§é˜…å…µï¼Œç¥ç¥–å›½ç¹è£å¯Œå¼º

ä»Šå¤©çœ‹äº†çœ‹å¤§é˜…å…µï¼Œæ„Ÿè§‰ä¸é”™ï¼Œæ–°è£…å¤‡ä¸å°‘ï¼Œçœ‹äº†çœ‹å›½å¤–é‚£ç¾¤æ±‰å¥¸ååº”ï¼Œéƒ½å¿«è¢«æ°”çº¢æ¸©äº†ï¼Œç¬‘æ­»æˆ‘äº†ï¼Œè¿™å›å¤Ÿç¾å›½ä½¬å–ä¸€å£¶äº†å“ˆå“ˆå“ˆã€‚

ä»Šå¤©å­¦äº†å­¦nomåº“ï¼Œæ„Ÿè§‰è¿˜ä¸é”™ï¼Œå°±æ˜¯æœ‰ç‚¹éº»çƒ¦ï¼Œä¸è¿‡å¬è¯´æ€§èƒ½å¯ä»¥ï¼Œè®°å½•ç¬”è®°

#### ç‰ˆæœ¬ 

```toml
nom="8.0.0"
```
æˆ‘ç”¨çš„ç‰ˆæœ¬æ˜¯8.0ç‰ˆæœ¬çš„ï¼Œç›®å‰ç½‘ä¸Šæ‰¾åˆ°çš„èµ„æ–™éƒ½æ˜¯ä»¥å‰ç‰ˆæœ¬çš„æœ‰çš„å‡½æ•°å·²ç»åºŸå¼ƒäº†ï¼Œéœ€è¦çœ‹å®˜æ–¹çš„è‹±æ–‡æ–‡æ¡£æ¥ï¼Œè‹±è¯­ä¸å¥½æ˜¯çœŸéš¾å— [æ–‡æ¡£åœ°å€](https://docs.rs/nom/latest/nom/)

#### ä½¿ç”¨

#### IResult

nomçš„é”™è¯¯å¤„ç†æšä¸¾,å…·ä½“ç±»å‹æ˜¯

```rust
pub type IResult<I, O, E = error::Error<I>> = Result<(I, O), Err<E>>;
// å…¶ä¸­Iæ˜¯è§£æåçš„å‰©ä½™éƒ¨åˆ†ï¼Œoæ˜¯è¢«è§£æç›®æ ‡å­—ç¬¦ä¸²ï¼ŒEæ˜¯é”™è¯¯
// æ¯”å¦‚
fn parse_sth(input:&str)->IResutl<&str,&str>{
    todo!()
}
//å…¶ä¸­nomçš„è§£æå“²å­¦æ˜¯ç»„åˆå­å’Œé›¶æ‹·è´
// æˆ‘ç›®å‰ç†è§£å¤§æ¦‚æ˜¯ä¸€ç§æ¶ˆè€—å½¢å¼

```




#### tag

```rust
pub fn tag<T, Input, Error: ParseError<Input>>(
    tag: T
) -> impl Fn(Input) -> IResult<Input, Input, Error> where
    Input: InputTake + Compare<T>,
    T: InputLength + Clone,

```

è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªè§£æå™¨ï¼Œå¤§è‡´ä½¿ç”¨æ–¹å¼æ˜¯è¿™æ ·

```rust
fn parse_test(input:&str)->IResult<&str,&str>
{
    tag("aaa").parse(input)
}
// è¿”å›ä¸€ä¸ªIResultæšä¸¾
let (res,match_str)=parse_test("aaabbb").unwrap();
//resæ˜¯bbb,match_stræ˜¯aaa
//8.0ä»¥å‰çš„ç‰ˆæœ¬æ˜¯å¯ä»¥çœç•¥æ‰parse
// æˆ‘ç”¨çš„ç°åœ¨ç‰ˆæœ¬ä¼¼ä¹æœ‰ç‚¹é—®é¢˜ï¼Œä¸èƒ½è¿™æ ·ç”¨ï¼Œä¼šæŠ¥é”™ï¼Œæœ‰ç‚¹æ€ª
```

é™¤æ¬¡ä¹‹å¤–è¿˜æœ‰

```rust
alpha0ï¼šè¯†åˆ«é›¶ä¸ªæˆ–å¤šä¸ªå°å†™å’Œå¤§å†™å­—æ¯å­—ç¬¦a-zA-Z]
alpha1 æ‰§è¡Œç›¸åŒæ“ä½œï¼Œä½†è¿”å›è‡³å°‘ä¸€ä¸ªå­—ç¬¦
alphanumeric0ï¼šè¯†åˆ«é›¶ä¸ªæˆ–å¤šä¸ªæ•°å­—å’Œå­—æ¯å­—ç¬¦[0-9a-zA-Z]
alphanumeric1 æ‰§è¡Œç›¸åŒæ“ä½œï¼Œä½†è¿”å›è‡³å°‘ä¸€ä¸ªå­—ç¬¦
digit0ï¼šè¯†åˆ«é›¶ä¸ªæˆ–å¤šä¸ªæ•°å­—å­—ç¬¦ï¼š/[0-9]/.
digit1æ‰§è¡Œç›¸åŒæ“ä½œï¼Œä½†è¿”å›è‡³å°‘ä¸€ä¸ªå­—ç¬¦
multispace0ï¼šè¯†åˆ«é›¶ä¸ªæˆ–å¤šä¸ªç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€å›è½¦ç¬¦å’Œæ¢è¡Œç¬¦ã€‚
multispace1 æ‰§è¡Œç›¸åŒæ“ä½œï¼Œä½†è¿”å›è‡³å°‘ä¸€ä¸ªå­—ç¬¦
space0ï¼šè¯†åˆ«é›¶ä¸ªæˆ–å¤šä¸ªç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦ã€‚
space1æ‰§è¡Œç›¸åŒæ“ä½œï¼Œä½†è¿”å›è‡³å°‘ä¸€ä¸ªå­—ç¬¦
line_endingï¼šè¯†åˆ«è¡Œå°¾ï¼ˆ\n å’Œ \r\nï¼‰
newlineï¼šåŒ¹é…æ¢è¡Œç¬¦\n
tabï¼šåŒ¹é…åˆ¶è¡¨ç¬¦ \t
```

#### ä¸€äº›ç»„åˆå‡½æ•°

```rust
use nom::{
    IResult, Parser,
    branch::alt,
    bytes::{complete::is_not, tag},
    character::{
        anychar,
        complete::{alpha0, char as char_parse, digit0, not_line_ending},
    },
    sequence::{delimited, pair, preceded, separated_pair, terminated},
};

// ========================================
// nom ç»„åˆå­æ•™å­¦ç¤ºä¾‹
// æ¯ä¸ªå‡½æ•°æ¼”ç¤ºä¸€ä¸ªæ ¸å¿ƒç»„åˆå­çš„ç”¨æ³•
// ========================================

/// alt: å°è¯•å¤šä¸ªè§£æå™¨ï¼Œè¿”å›**ç¬¬ä¸€ä¸ªæˆåŠŸ**çš„ç»“æœ
/// - é€‚ç”¨äºâ€œå¤šç§å¯èƒ½ä¹‹ä¸€â€çš„åœºæ™¯ï¼ˆå¦‚å…³é”®å­—ã€åè®®ç‰ˆæœ¬ç­‰ï¼‰
/// - ä¸€æ—¦æŸä¸ªå­è§£æå™¨æˆåŠŸï¼Œå°±ä¸å†å°è¯•åé¢çš„
/// - å¦‚æœå…¨éƒ¨å¤±è´¥ï¼Œè¿”å›æœ€åä¸€ä¸ªé”™è¯¯
fn parse_alt(input: &str) -> IResult<&str, &str> {
    alt((
        tag("aaa"), // å°è¯•åŒ¹é…å­—é¢é‡ "aaa"
        tag("bbb"), // è‹¥å¤±è´¥ï¼Œå°è¯• "bbb"
        tag("ccc"), // è‹¥å†å¤±è´¥ï¼Œå°è¯• "ccc"
    ))
    .parse(input)
}

/// delimited: è§£æâ€œè¢«åŒ…å›´â€çš„å†…å®¹
/// ç»“æ„ï¼šå‰ç¼€ + ä¸»ä½“ + åç¼€
/// å¸¸ç”¨äºæ‹¬å·ã€å¼•å·ã€å—ç»“æ„ç­‰
fn parens(input: &str) -> IResult<&str, &str> {
    delimited(
        char_parse('('), // å‰ç¼€ï¼šå·¦æ‹¬å· '('
        is_not(")"),     // ä¸»ä½“ï¼šä»»æ„ä¸æ˜¯ ')' çš„å­—ç¬¦ï¼ˆå³æ‹¬å·å†…çš„å†…å®¹ï¼‰
        char_parse(')'), // åç¼€ï¼šå³æ‹¬å· ')'
    )
    .parse(input)
}

/// tuple: é¡ºåºè§£æå¤šä¸ªç‹¬ç«‹éƒ¨åˆ†ï¼Œè¿”å›ä¸€ä¸ªå…ƒç»„
/// æ‰€æœ‰éƒ¨åˆ†å¿…é¡»è¿ç»­ä¸”å…¨éƒ¨æˆåŠŸ
fn parse_tuple(input: &str) -> IResult<&str, (&str, &str, &str)> {
    (
        tag("aaa"), // å…ˆåŒ¹é… "aaa"
        tag("bbb"), // ç„¶ååŒ¹é… "bbb"
        tag("ccc"), // æœ€ååŒ¹é… "ccc"
    )
        .parse(input)
    // è¿”å› ((å‰©ä½™è¾“å…¥), ("aaa", "bbb", "ccc"))
}

/// delimited ç¤ºä¾‹ï¼šä¸ parens ç›¸åŒï¼Œç”¨äºå¯¹æ¯”å‘½å
/// è§£æè¢«æ‹¬å·åŒ…å›´çš„å†…å®¹ï¼Œè¿”å›æ‹¬å·å†…çš„å­—ç¬¦ä¸²
fn parse_delimited(input: &str) -> IResult<&str, &str> {
    delimited(
        char_parse('('), // å‰ç¼€ '('
        is_not(")"),     // å†…å®¹ï¼šé ')' å­—ç¬¦
        char_parse(')'), // åç¼€ ')'
    )
    .parse(input)
}

/// preceded: è§£æâ€œå‰ç¼€ä¹‹åçš„å†…å®¹â€
/// ç»“æ„ï¼šå‰ç¼€ + ç›®æ ‡å†…å®¹ â†’ è¿”å›ç›®æ ‡å†…å®¹
/// å¸¸ç”¨äºæå– @ ä¹‹åçš„åŸŸåã€å†’å·åçš„å€¼ç­‰
fn parse_preced(input: &str) -> IResult<&str, &str> {
    preceded(
        (digit0, char_parse('@')), // å‰ç¼€ï¼šä»»æ„æ•°å­— + '@' ç¬¦å·
        not_line_ending,           // ç›®æ ‡å†…å®¹ï¼šç›´åˆ°è¡Œå°¾ä¹‹å‰çš„æ‰€æœ‰å­—ç¬¦ï¼ˆå³åŸŸåï¼‰
    )
    .parse(input)
    // ç¤ºä¾‹: "2779753429@qq.com" â†’ è¿”å› "qq.com"
}

/// terminated: è§£æâ€œä»¥æŸå†…å®¹ç»“å°¾â€çš„ç»“æ„
/// ç»“æ„ï¼šç›®æ ‡å†…å®¹ + åç¼€ â†’ è¿”å›ç›®æ ‡å†…å®¹
/// å¸¸ç”¨äºæå–å†’å·å‰çš„é”®ã€åˆ†å·å‰çš„è¯­å¥ç­‰
fn parse_terminated(input: &str) -> IResult<&str, &str> {
    terminated(
        is_not(":"),        // ç›®æ ‡å†…å®¹ï¼šä»»æ„éå†’å·å­—ç¬¦
        char_parse(':'),    // åç¼€ï¼šå†’å· ':'
    )
    .parse(input)
    // ç¤ºä¾‹: "email:password" â†’ è¿”å› "email"
}

/// pair: è§£æä¸¤ä¸ªè¿ç»­çš„éƒ¨åˆ†ï¼Œè¿”å›äºŒå…ƒç»„ (part1, part2)
/// ä¸è·³è¿‡åˆ†éš”ç¬¦ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†
/// è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ç”¨ `preceded` å¤„ç† ": " åˆ†éš”ç¬¦
fn parse_pair(input: &str) -> IResult<&str, (&str, &str)> {
    pair(
        is_not(":"),                         // ç¬¬ä¸€éƒ¨åˆ†ï¼šå†’å·å‰çš„å†…å®¹ï¼ˆå¦‚é”®åï¼‰
        preceded(tag(": "), not_line_ending), // ç¬¬äºŒéƒ¨åˆ†ï¼š": " ä¹‹ååˆ°è¡Œå°¾çš„å†…å®¹ï¼ˆå¦‚å€¼ï¼‰
    )
    .parse(input)
}

/// separated_pair: è§£æâ€œè¢«åˆ†éš”ç¬¦åˆ†å¼€â€çš„ä¸¤ä¸ªéƒ¨åˆ†
/// ç»“æ„ï¼špart1 + separator + part2 â†’ è¿”å› (part1, part2)
/// æ˜¯ `pair` + `preceded` çš„æ›´ç®€æ´ç‰ˆæœ¬
fn parse_separated_pair(input: &str) -> IResult<&str, (&str, &str)> {
    separated_pair(
        is_not(":"),    // ç¬¬ä¸€éƒ¨åˆ†ï¼šéå†’å·å­—ç¬¦ï¼ˆé”®ï¼‰
        tag(": "),      // åˆ†éš”ç¬¦ï¼š": "ï¼ˆæ³¨æ„ç©ºæ ¼ï¼‰
        is_not(":"),    // ç¬¬äºŒéƒ¨åˆ†ï¼šéå†’å·å­—ç¬¦ï¼ˆå€¼ï¼‰
        // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾å€¼ä¸­ä¸å« ':'
    )
    .parse(input)
}

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // å¯åœ¨æ­¤å¤„æ·»åŠ å®é™…è§£æç¤ºä¾‹
    Ok(())
}

#[cfg(test)]
mod test {
    const POST: &str = r#"POST /api/users HTTP/1.1
Host: example.com
Content-Type: application/json
Content-Length: 45
Connection: close

{"name": "Alice", "age": 30, "city": "Beijing"}"#;

    use super::*;

    #[test]
    fn test_alt() {
        let test_str = "aaa,bbb,ccc";
        let (_, match_str) = parse_alt(test_str).unwrap();
        assert_eq!("aaa", match_str); // alt åŒ¹é…ç¬¬ä¸€ä¸ªæˆåŠŸçš„ "aaa"
    }

    #[test]
    fn test_tuple() {
        let test_str = "aaabbbccc";
        let (_, (a, b, c)) = parse_tuple(test_str).unwrap();
        assert_eq!("aaa", a);
        assert_eq!("bbb", b);
        assert_eq!("ccc", c);
    }

    #[test]
    fn test_delimited() {
        let test_str = "(aaa,bbbccc)";
        let (_, match_str) = parse_delimited(test_str).unwrap();
        assert_eq!(match_str, "aaa,bbbccc"); // è¿”å›æ‹¬å·å†…çš„å†…å®¹
    }

    #[test]
    fn test_preceed() {
        let test_str = "2779753429@qq.com";
        let (_, domain) = parse_preced(test_str).unwrap();
        assert_eq!("qq.com", domain); // æå– @ ä¹‹åçš„åŸŸå
    }

    #[test]
    fn test_terminated() {
        let test_str = "2779753429@qq.com:VR2050";
        let (_, email) = parse_terminated(test_str).unwrap();
        assert_eq!(email, "2779753429@qq.com"); // æå– : ä¹‹å‰çš„å†…å®¹
    }

    #[test]
    fn test_pari() {
        let test_str = "User-Agent: Mozilia Fire Fox 1.1";
        // æ³¨æ„ï¼šåŸå‡½æ•°å typoï¼Œåº”ä¸º `parse_separated_pair`
        let (_, (k, v)) = parse_separated_pair(test_str).unwrap();
        assert_eq!("User-Agent", k);
        assert_eq!("Mozilia Fire Fox 1.1", v);
    }
}
```
å¤§è‡´å°±è¿™äº›
æ„Ÿè§‰ç”¨è¿™ä¸ªæœ‰ç‚¹éº»çƒ¦ä½†æ˜¯å§ï¼Œä»–ç›¸æ¯”regexæ€§èƒ½è¦æ›´å¼ºä¸€ç‚¹
æŠ½æ—¶é—´æŠŠæˆ‘é‚£ä¸ªshit requestè§£æå™¨é‡å†™ä¸€ä¸‹ğŸ˜

